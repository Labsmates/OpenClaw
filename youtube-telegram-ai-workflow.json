{
  "name": "YouTube â†’ Telegram AI Enhanced",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 12
            },
            {
              "triggerAtHour": 20
            }
          ]
        }
      },
      "id": "cron-trigger",
      "name": "Cron 12h & 20h",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 300]
    },
    {
      "parameters": {
        "filePath": "/app/workspace/youtube-monitor-vip-state.json",
        "options": {}
      },
      "id": "read-state",
      "name": "Load VIP State File",
      "type": "n8n-nodes-base.readBinaryFile",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "jsCode": "const stateData = JSON.parse($input.first().binary.data.toString());\n\nreturn [\n  {\n    json: {\n      channels: stateData.channels || [],\n      sent_videos: stateData.sent_videos || [],\n      timestamp: new Date().toISOString()\n    }\n  }\n];"
      },
      "id": "parse-state",
      "name": "Parse State",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "channel-loop",
              "name": "channel_id",
              "value": "={{ $json.channels }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "id": "split-channels",
      "name": "Split Channels",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [900, 300]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "loop-channels",
      "name": "Loop Channels",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "url": "=https://www.youtube.com/feeds/videos.xml?channel_id={{ $json.channel_id[0] }}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "fetch-rss",
      "name": "Fetch YouTube RSS",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "jsCode": "// Parse XML RSS YouTube avec extraction de la description\nconst xml = $input.first().json.body;\nconst sentVideos = $('Parse State').first().json.sent_videos;\n\nconst videoMatches = xml.matchAll(/<entry>([\\s\\S]*?)<\\/entry>/g);\nconst videos = [];\nconst now = new Date();\nconst maxAgeDays = 3;\n\nfor (const match of videoMatches) {\n  const entry = match[1];\n  \n  const videoIdMatch = entry.match(/<yt:videoId>([^<]+)<\\/yt:videoId>/);\n  const titleMatch = entry.match(/<title>([^<]+)<\\/title>/);\n  const publishedMatch = entry.match(/<published>([^<]+)<\\/published>/);\n  const authorMatch = entry.match(/<name>([^<]+)<\\/name>/);\n  const descMatch = entry.match(/<media:description>([\\s\\S]*?)<\\/media:description>/);\n  \n  if (!videoIdMatch || !titleMatch || !publishedMatch) continue;\n  \n  const videoId = videoIdMatch[1];\n  const title = titleMatch[1];\n  const published = publishedMatch[1];\n  const channel = authorMatch ? authorMatch[1] : 'Unknown';\n  const description = descMatch ? descMatch[1].substring(0, 500) : '';\n  \n  const pubDate = new Date(published);\n  const ageDays = Math.floor((now - pubDate) / (1000 * 60 * 60 * 24));\n  \n  if (ageDays > maxAgeDays) continue;\n  if (sentVideos.includes(videoId)) continue;\n  \n  const isShort = title.toLowerCase().includes('#shorts') || title.toLowerCase().includes('#short');\n  if (isShort) {\n    sentVideos.push(videoId);\n    continue;\n  }\n  \n  videos.push({\n    id: videoId,\n    title: title,\n    channel: channel,\n    description: description,\n    published: published,\n    age_days: ageDays,\n    url: `https://www.youtube.com/watch?v=${videoId}`\n  });\n  \n  sentVideos.push(videoId);\n}\n\nreturn videos.map(v => ({ json: v }));"
      },
      "id": "parse-videos",
      "name": "Parse & Filter Videos",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openRouterApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $vars.OPENROUTER_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"anthropic/claude-3.5-sonnet\",\n  \"messages\": [\n    {\n      \"role\": \"user\",\n      \"content\": \"Analyse cette vidÃ©o YouTube et gÃ©nÃ¨re un message Telegram engageant.\\n\\nTitre: {{ $json.title }}\\nChaÃ®ne: {{ $json.channel }}\\nDescription: {{ $json.description }}\\n\\nGÃ©nÃ¨re un message court (2-3 lignes max) qui:\\n- RÃ©sume le contenu principal\\n- Utilise 1-2 emojis pertinents\\n- Donne envie de cliquer\\n- Reste naturel et concis\\n\\nFormat attendu:\\n[emoji] [RÃ©sumÃ© en 1-2 phrases courtes]\\n\\nRÃ©ponds UNIQUEMENT avec le message, sans explication.\"\n    }\n  ],\n  \"temperature\": 0.7,\n  \"max_tokens\": 150\n}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "ai-analyze",
      "name": "AI Analysis (Claude)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1780, 300]
    },
    {
      "parameters": {
        "jsCode": "const video = $input.first().json;\nconst aiResponse = video.choices?.[0]?.message?.content || '';\nconst ageText = video.age_days > 0 ? `${video.age_days}j` : \"aujourd'hui\";\n\n// Nettoie la rÃ©ponse IA (enlÃ¨ve guillemets, markdown superflus)\nconst aiSummary = aiResponse.trim().replace(/^[\"']|[\"']$/g, '');\n\nreturn [{\n  json: {\n    message: `${aiSummary}\\n\\nðŸ‘¤ ${video.channel} â€¢ ðŸ“… ${ageText}\\nðŸ”— ${video.url}`,\n    video_id: video.id,\n    video_title: video.title\n  }\n}];"
      },
      "id": "format-message",
      "name": "Format Enhanced Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot{{ $vars.TELEGRAM_BOT_TOKEN }}/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "[VOTRE_TELEGRAM_CHAT_ID]"
            },
            {
              "name": "text",
              "value": "={{ $json.message }}"
            },
            {
              "name": "disable_web_page_preview",
              "value": "false"
            }
          ]
        },
        "options": {}
      },
      "id": "send-telegram",
      "name": "Send to Telegram",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2220, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.ok }}",
              "value2": "true"
            }
          ]
        }
      },
      "id": "check-sent",
      "name": "Check if Sent",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2440, 300]
    },
    {
      "parameters": {
        "jsCode": "const allSentIds = $input.all().map(item => item.json.video_id);\nconst oldState = $('Parse State').first().json;\n\nconst updatedSentVideos = [...new Set([...oldState.sent_videos, ...allSentIds])];\n\nconst newState = {\n  channels: oldState.channels,\n  sent_videos: updatedSentVideos\n};\n\nreturn [{\n  json: {\n    state: newState,\n    new_videos_count: allSentIds.length\n  }\n}];"
      },
      "id": "update-state",
      "name": "Update State",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2660, 200]
    },
    {
      "parameters": {
        "operation": "write",
        "fileName": "/app/workspace/youtube-monitor-vip-state.json",
        "inputDataFieldName": "={{ JSON.stringify($json.state, null, 2) }}",
        "options": {}
      },
      "id": "save-state",
      "name": "Save VIP State File",
      "type": "n8n-nodes-base.writeFile",
      "typeVersion": 1,
      "position": [2880, 200]
    },
    {
      "parameters": {
        "jsCode": "const count = $input.first().json.new_videos_count;\nconsole.log(`âœ… AI-enhanced YouTube monitoring: ${count} videos sent`);\nreturn $input.all();"
      },
      "id": "log-complete",
      "name": "Log Complete",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3100, 200]
    }
  ],
  "connections": {
    "Cron 12h & 20h": {
      "main": [
        [
          {
            "node": "Load State File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load State File": {
      "main": [
        [
          {
            "node": "Parse State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse State": {
      "main": [
        [
          {
            "node": "Split Channels",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Channels": {
      "main": [
        [
          {
            "node": "Loop Channels",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Channels": {
      "main": [
        [
          {
            "node": "Fetch YouTube RSS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch YouTube RSS": {
      "main": [
        [
          {
            "node": "Parse & Filter Videos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse & Filter Videos": {
      "main": [
        [
          {
            "node": "AI Analysis (Claude)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Analysis (Claude)": {
      "main": [
        [
          {
            "node": "Format Enhanced Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Enhanced Message": {
      "main": [
        [
          {
            "node": "Send to Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send to Telegram": {
      "main": [
        [
          {
            "node": "Check if Sent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Sent": {
      "main": [
        [
          {
            "node": "Update State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update State": {
      "main": [
        [
          {
            "node": "Save State File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save State File": {
      "main": [
        [
          {
            "node": "Log Complete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "pinData": {},
  "versionId": "1"
}
